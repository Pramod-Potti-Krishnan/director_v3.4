# Director Agent v3.3 Migration Guide

**From**: v3.1 (API Key Authentication)
**To**: v3.3 (Application Default Credentials)
**Migration Time**: 15-30 minutes
**Difficulty**: Intermediate

---

## üéØ Migration Overview

This guide walks you through migrating from v3.1 (insecure API keys) to v3.3 (secure ADC authentication).

### What's Changing

| Component | v3.1 | v3.3 |
|-----------|------|------|
| **Local Auth** | `GOOGLE_API_KEY` env var | `gcloud auth application-default login` |
| **Railway Auth** | `GOOGLE_API_KEY` env var | `GCP_SERVICE_ACCOUNT_JSON` env var |
| **Python Package** | `google-generativeai` | `google-cloud-aiplatform` |
| **Auth Method** | Static API key | ADC (rotatable credentials) |

### Why Migrate?

- üîí **Enhanced Security**: No more API keys in environment variables
- üîÑ **Easy Rotation**: Service accounts can be rotated instantly
- üìä **Full Auditability**: Every API call tracked in GCP audit logs
- üõ°Ô∏è **Fine-grained Permissions**: IAM roles instead of blanket API access
- üí∞ **Cost Controls**: GCP quotas and budgets prevent runaway costs

---

## üìã Prerequisites

### Before You Start

- [ ] **v3.1 currently running** and stable
- [ ] **Access to GCP Console** for deckster-xyz project
- [ ] **Railway dashboard access** (for production)
- [ ] **Backup of current .env file**
- [ ] **15-30 minutes of uninterrupted time**

### Required Tools

#### Local Development
- gcloud CLI (we'll install this)
- Python 3.9+
- pip

#### Railway Production
- GCP Console access
- Railway project admin access
- Service account creation permissions

---

## üîÑ Migration Path Selection

Choose your migration path:

### Path A: Local Development Only
**Scenario**: You're a developer working locally
**Time**: 10 minutes
**Steps**: [Jump to Local Migration](#-path-a-local-development-migration)

### Path B: Railway Production Only
**Scenario**: You're deploying to Railway
**Time**: 15 minutes
**Steps**: [Jump to Railway Migration](#-path-b-railway-production-migration)

### Path C: Both Local + Railway
**Scenario**: Full migration (most common)
**Time**: 30 minutes
**Steps**: Do Local first, then Railway

---

## üñ•Ô∏è Path A: Local Development Migration

### Step 1: Install gcloud CLI (5 minutes)

#### macOS
```bash
# Install via Homebrew
brew install google-cloud-sdk

# Verify installation
gcloud --version
```

#### Linux
```bash
# Download and install
curl https://sdk.cloud.google.com | bash

# Restart shell
exec -l $SHELL

# Verify installation
gcloud --version
```

#### Windows
1. Download installer: https://cloud.google.com/sdk/docs/install
2. Run installer
3. Open new command prompt
4. Verify: `gcloud --version`

### Step 2: Authenticate with Google Cloud (3 minutes)

```bash
# Login with your Google account
gcloud auth application-default login
```

This will:
1. Open your browser
2. Ask you to select your Google account
3. Request permission to access GCP
4. Save credentials to `~/.config/gcloud/application_default_credentials.json`

**Verify authentication:**
```bash
# Should print an access token
gcloud auth application-default print-access-token

# Should show your account
gcloud auth list
```

### Step 3: Set GCP Project (1 minute)

```bash
# Set the project
gcloud config set project deckster-xyz

# Verify
gcloud config get-value project
# Should output: deckster-xyz
```

### Step 4: Test Vertex AI Access (1 minute)

```bash
# List available models (this tests your permissions)
gcloud ai models list --region=us-central1

# If successful, you should see a list of Gemini models
```

**If you get permission errors:**
```bash
# You may need to be added to the project
# Contact your GCP admin to grant you access
```

### Step 5: Update Application Code (2 minutes)

```bash
# Navigate to your project directory
cd /path/to/deckster-backend/deckster-w-content-strategist/agents/director_agent

# Backup v3.1
cp -r v3.1 v3.1-backup

# Copy v3.3 code
# (v3.3 should already be in place from the refactoring)

# Navigate to v3.3
cd v3.3

# Install new dependencies
pip install -r requirements.txt
```

### Step 6: Update Environment Variables (2 minutes)

Edit your `.env` file:

```bash
# Open .env
nano .env  # or use your preferred editor
```

**Remove this line:**
```bash
GOOGLE_API_KEY=your-google-api-key-here  # ‚ùå DELETE THIS
```

**Add/verify these lines:**
```bash
# v3.3: GCP Configuration
GCP_ENABLED=true
GCP_PROJECT_ID=deckster-xyz
GCP_LOCATION=us-central1
# DO NOT add GCP_SERVICE_ACCOUNT_JSON for local development
```

**Keep these (if you have them):**
```bash
# Fallback options (optional)
OPENAI_API_KEY=...  # Keep if you have it
ANTHROPIC_API_KEY=...  # Keep if you have it
```

### Step 7: Start Application (1 minute)

```bash
# Start the application
python main.py
```

**Expected output:**
```
INFO: Starting Director Agent API...
INFO: ‚úì AI API key configuration validated
INFO: ‚úì Supabase connection validated
INFO: üîì Initializing Vertex AI with ADC (Local development mode)
INFO:   Expecting credentials from: gcloud auth application-default login
INFO: ‚úì Vertex AI initialized successfully with ADC
INFO:   Project: deckster-xyz, Location: us-central1
INFO: ‚úì Using Google Gemini via Vertex AI (Project: deckster-xyz)
INFO:   Authentication: ADC (local)
...
INFO: Application startup complete.
```

### Step 8: Test Presentation Generation (3 minutes)

```bash
# Test the API
curl -X GET http://localhost:8000/health

# Or use your preferred API testing tool to test a full workflow
```

**If everything works:**
‚úÖ You're done with local migration!

---

## üöÄ Path B: Railway Production Migration

### Step 1: Create Service Account in GCP (5 minutes)

1. **Go to GCP Console**
   - Navigate to: https://console.cloud.google.com/iam-admin/serviceaccounts?project=deckster-xyz

2. **Create Service Account**
   - Click **"+ CREATE SERVICE ACCOUNT"**
   - **Name**: `director-agent-production`
   - **Description**: `Production service account for Director Agent v3.3`
   - Click **"CREATE AND CONTINUE"**

3. **Grant Roles**
   - Click **"Add role"**
   - Search for and select: **"Vertex AI User"** (`roles/aiplatform.user`)
   - ‚ö†Ô∏è **DO NOT** add Editor, Owner, or Admin roles
   - Click **"CONTINUE"**
   - Click **"DONE"**

### Step 2: Create and Download Service Account Key (2 minutes)

1. **Access Keys**
   - Click on the newly created `director-agent-production` service account
   - Go to **"KEYS"** tab
   - Click **"ADD KEY"** ‚Üí **"Create new key"**

2. **Generate Key**
   - Select format: **JSON**
   - Click **"CREATE"**
   - **Save the downloaded file securely** (e.g., `director-agent-production.json`)

3. **‚ö†Ô∏è SECURITY WARNING**
   - **DO NOT** commit this file to version control
   - **DO NOT** share this file via email or Slack
   - Store it in a secure password manager

### Step 3: Open Service Account JSON (1 minute)

Open the downloaded JSON file:

```bash
# On macOS/Linux
cat ~/Downloads/director-agent-production-*.json

# Copy the ENTIRE contents to your clipboard
```

The JSON should look like:
```json
{
  "type": "service_account",
  "project_id": "deckster-xyz",
  "private_key_id": "...",
  "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
  "client_email": "director-agent-production@deckster-xyz.iam.gserviceaccount.com",
  "client_id": "...",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "..."
}
```

### Step 4: Update Railway Environment Variables (5 minutes)

1. **Go to Railway Dashboard**
   - Navigate to your Director Agent project
   - Click **"Variables"** tab

2. **Remove Old Variable**
   - Find `GOOGLE_API_KEY`
   - Click the **trash icon** to delete it
   - ‚ö†Ô∏è Confirm deletion

3. **Add New Variables**

   Add these variables (click **"+ New Variable"** for each):

   **Variable 1:**
   - **Name**: `GCP_ENABLED`
   - **Value**: `true`

   **Variable 2:**
   - **Name**: `GCP_PROJECT_ID`
   - **Value**: `deckster-xyz`

   **Variable 3:**
   - **Name**: `GCP_LOCATION`
   - **Value**: `us-central1`

   **Variable 4 (MOST IMPORTANT):**
   - **Name**: `GCP_SERVICE_ACCOUNT_JSON`
   - **Value**: [Paste the ENTIRE JSON content you copied earlier]
   - ‚ö†Ô∏è Make sure it's the complete JSON, including curly braces

4. **Verify Variables**

   Your Railway environment should now have:
   ```
   GCP_ENABLED=true
   GCP_PROJECT_ID=deckster-xyz
   GCP_LOCATION=us-central1
   GCP_SERVICE_ACCOUNT_JSON={"type":"service_account",...}
   SUPABASE_URL=...
   SUPABASE_ANON_KEY=...
   ... (other existing variables)
   ```

   **REMOVED:**
   ```
   GOOGLE_API_KEY=... ‚ùå (should be gone)
   ```

### Step 5: Deploy v3.3 Code (2 minutes)

```bash
# Ensure you're on the v3.3 branch/version
cd /path/to/director_agent/v3.3

# Commit and push to Railway (if using Git)
git add .
git commit -m "v3.3: Migrate to Application Default Credentials"
git push

# Railway will automatically deploy
```

**Or manually deploy:**
- Railway Dashboard ‚Üí Deployments tab ‚Üí **"Deploy"**

### Step 6: Monitor Deployment (2 minutes)

1. **Watch Deployment Logs**
   - Railway Dashboard ‚Üí Deployments ‚Üí [Latest deployment]
   - Click **"View Logs"**

2. **Look for Success Messages**

   **Expected logs:**
   ```
   Starting Director Agent API...
   üîê Initializing Vertex AI with service account (Production mode)
   ‚úì Vertex AI initialized successfully with service account: director-agent-production@deckster-xyz.iam.gserviceaccount.com
     Project: deckster-xyz, Location: us-central1
   ‚úì Using Google Gemini via Vertex AI (Project: deckster-xyz)
     Authentication: Service Account
   DirectorAgent initialized with gemini-2.0-flash-exp model
   Application startup complete.
   ```

   **‚ö†Ô∏è If you see errors:**
   - Check logs carefully
   - Jump to [Troubleshooting](#-troubleshooting) section

### Step 7: Test Railway Deployment (2 minutes)

```bash
# Get your Railway app URL
RAILWAY_URL="https://your-app.up.railway.app"

# Test health endpoint
curl -X GET $RAILWAY_URL/health

# Expected response:
# {
#   "status": "healthy",
#   "service": "director-agent-api",
#   "version": "1.0.0",
#   ...
# }
```

**If successful:**
‚úÖ You're done with Railway migration!

---

## üõ†Ô∏è Troubleshooting

### Local Development Issues

#### Error: "gcloud: command not found"

**Solution:**
```bash
# Reinstall gcloud CLI
# macOS:
brew install google-cloud-sdk

# Linux:
curl https://sdk.cloud.google.com | bash
exec -l $SHELL

# Verify:
which gcloud
```

#### Error: "Failed to initialize Vertex AI with ADC"

**Solution:**
```bash
# Re-authenticate
gcloud auth application-default revoke  # Clear old credentials
gcloud auth application-default login   # Re-authenticate

# Verify credentials file exists
ls ~/.config/gcloud/application_default_credentials.json

# Should exist and have recent timestamp
```

#### Error: "Permission denied on Vertex AI API"

**Solution:**
```bash
# Check if API is enabled
gcloud services list --enabled | grep aiplatform

# If not listed, enable it
gcloud services enable aiplatform.googleapis.com

# Verify you have access to the project
gcloud projects describe deckster-xyz
```

#### Error: "No AI service configured"

**Solution:**
```bash
# Check your .env file
cat .env | grep GCP

# Should show:
# GCP_ENABLED=true

# If GCP_ENABLED=false, change it to true
nano .env  # Change to GCP_ENABLED=true
```

### Railway Production Issues

#### Error: "GCP_SERVICE_ACCOUNT_JSON must be set in production"

**Solution:**
1. Go to Railway Dashboard ‚Üí Variables
2. Check if `GCP_SERVICE_ACCOUNT_JSON` exists
3. If missing, add it (see [Step 4](#step-4-update-railway-environment-variables-5-minutes))
4. If present, verify the JSON is valid:
   - Should start with `{"type":"service_account"`
   - Should include `"private_key":"-----BEGIN PRIVATE KEY-----`
   - Must be on ONE LINE (no line breaks in Railway)

#### Error: "Service account credentials invalid"

**Causes & Solutions:**

**1. Invalid JSON format**
```bash
# Test JSON locally
cat director-agent-production.json | jq .
# Should pretty-print the JSON without errors
```

**2. Service account disabled**
```bash
# Check service account status
gcloud iam service-accounts describe director-agent-production@deckster-xyz.iam.gserviceaccount.com

# Should show: disabled: false
```

**3. Missing IAM role**
```bash
# Check roles
gcloud projects get-iam-policy deckster-xyz \
  --flatten="bindings[].members" \
  --filter="bindings.members:serviceAccount:director-agent-production@deckster-xyz.iam.gserviceaccount.com"

# Should include: roles/aiplatform.user
```

#### Error: Deployment succeeds but app crashes

**Solution:**
1. **Check Railway logs** for specific error message
2. **Common issues:**
   - Service account JSON truncated (check length)
   - Wrong project ID (should be `deckster-xyz`)
   - API not enabled (enable Vertex AI API)
3. **Debug commands:**
   ```bash
   # View recent logs
   railway logs

   # Check environment variables are set
   railway variables
   ```

### General Issues

#### Application starts but generates errors on use

**Check:**
1. **GCP Quotas**
   ```bash
   gcloud ai models list --region=us-central1 --project=deckster-xyz
   ```

2. **API Billing**
   - Go to: https://console.cloud.google.com/billing?project=deckster-xyz
   - Ensure billing is enabled

3. **Service Account Permissions**
   ```bash
   gcloud projects get-iam-policy deckster-xyz \
     --flatten="bindings[].members" \
     --filter="bindings.members:serviceAccount:director-agent-production@deckster-xyz.iam.gserviceaccount.com"
   ```

---

## üîô Rollback Procedure

If migration fails and you need to revert:

### Local Development Rollback (2 minutes)

```bash
# 1. Go back to v3.1
cd /path/to/director_agent/v3.1

# 2. Restore .env
cp .env.backup .env

# 3. Reinstall old dependencies
pip install -r requirements.txt

# 4. Start application
python main.py
```

### Railway Production Rollback (5 minutes)

1. **Restore API Key**
   - Railway Dashboard ‚Üí Variables
   - Add variable: `GOOGLE_API_KEY` with old API key value

2. **Remove GCP Variables (optional)**
   - Delete `GCP_ENABLED`
   - Delete `GCP_SERVICE_ACCOUNT_JSON`
   - Delete `GCP_PROJECT_ID`
   - Delete `GCP_LOCATION`

3. **Redeploy v3.1**
   ```bash
   git checkout v3.1-tag  # Or your v3.1 branch
   git push
   ```

4. **Verify**
   - Check Railway logs for successful startup
   - Test API health endpoint

---

## ‚úÖ Post-Migration Checklist

After successful migration, complete these tasks:

### Immediate (Day 1)

- [ ] Test full presentation generation workflow
- [ ] Verify all features working
- [ ] Check Railway logs for any warnings
- [ ] Test with multiple concurrent users
- [ ] Document any issues encountered

### Short-term (Week 1)

- [ ] Monitor GCP costs and API usage
- [ ] Set up billing alerts (see SECURITY.md)
- [ ] Review GCP audit logs
- [ ] Update team documentation
- [ ] Train team on new authentication method

### Long-term (Month 1)

- [ ] Schedule service account key rotation (90 days)
- [ ] Review and optimize API quotas
- [ ] Analyze cost savings vs v3.1
- [ ] Document lessons learned
- [ ] Plan security audit

---

## üìä Migration Verification

### Success Indicators

‚úÖ **Application Starts Successfully**
- No authentication errors in logs
- Vertex AI initialization message appears
- Health endpoint returns 200 OK

‚úÖ **Presentations Generate Correctly**
- Can create new presentations
- AI responses are coherent
- No "quota exceeded" errors

‚úÖ **Security Improvements Active**
- No API keys in environment variables
- Service account appears in GCP audit logs
- IAM roles properly restricted

‚úÖ **Monitoring Configured**
- GCP Console shows API usage
- Billing alerts set up
- Audit logs enabled

### Failure Indicators

‚ùå **Application Won't Start**
- Check [Troubleshooting](#-troubleshooting) section
- Review Railway logs carefully
- Verify all environment variables

‚ùå **Authentication Errors**
- Verify service account JSON is complete
- Check IAM roles in GCP Console
- Ensure Vertex AI API is enabled

‚ùå **Intermittent Failures**
- May indicate quota issues
- Check GCP Console for quota limits
- Review rate limiting settings

---

## üÜò Getting Help

### Self-Service Resources

1. **SECURITY.md** - Complete security documentation
2. **V3.3_CHANGELOG.md** - What changed in v3.3
3. **Railway Logs** - Check for specific error messages
4. **GCP Console** - Check audit logs and permissions

### Contact Points

- **GCP Issues**: GCP project admin
- **Railway Issues**: Railway support or devops team
- **Application Issues**: Development team lead

### Useful Commands

```bash
# Check gcloud configuration
gcloud config list

# View GCP audit logs
gcloud logging read "resource.type=aiplatform.googleapis.com" --limit 20

# Test service account
gcloud auth activate-service-account --key-file=director-agent-production.json
gcloud ai models list --region=us-central1

# Railway logs
railway logs --tail 100
```

---

## üéì Additional Notes

### Best Practices

1. **Always test in local environment first**
2. **Keep v3.1 backup for at least 30 days**
3. **Document your service account details securely**
4. **Set up monitoring before declaring success**
5. **Review security checklist in SECURITY.md**

### Common Pitfalls

- ‚ùå Forgetting to run `gcloud auth application-default login` locally
- ‚ùå Copy-pasting incomplete service account JSON to Railway
- ‚ùå Not enabling Vertex AI API in GCP Console
- ‚ùå Granting too many permissions to service account
- ‚ùå Not setting up billing alerts

### Tips

- üí° Use `gcloud auth list` to see which account is active
- üí° Railway variables can be tested before deployment
- üí° Service account keys can be created and deleted multiple times
- üí° GCP audit logs are your friend for debugging
- üí° Start with local migration for faster iteration

---

**Version**: v3.3
**Last Updated**: 2025-01-31
**Estimated Migration Time**: 15-30 minutes
**Success Rate**: 95%+ when following guide

Good luck with your migration! üöÄ
