# Director v3.4 â†’ Text Service v1.2 Integration Plan

**Date**: 2025-11-04
**Status**: IN PROGRESS (Phase 9 of 10)
**Version**: Director v3.4 + Text Service v1.2

---

## ğŸ¯ Executive Summary

Integration of Director Agent v3.4 with Text Service v1.2 to leverage 34 platinum variants with:
1. **Random variant selection** for visual variety (equal probability among variants)
2. **Director-generated titles/subtitles/footers** with strict character limits (50/90/20)
3. **Text Service focused on rich_content HTML** body generation only

---

## ğŸ“Š Key Architecture Decisions

### Character Limit Enforcement
- **Title**: 50 characters max (Pydantic `Field(max_length=50)`)
- **Subtitle**: 90 characters max (Pydantic `Field(max_length=90)`)
- **Footer**: 20 characters max (Pydantic `Field(max_length=20)`)

**Enforcement**:
1. LLM prompts include character limits
2. Pydantic validates on model creation
3. Fallback truncation with "..." if needed

### Variant Selection Flow
```
GENERATE_STRAWMAN stage:
1. Classify slide â†’ "matrix_2x2" (Director's 13 types)
2. Map to slide type â†’ "matrix" (v1.2's 10 types)
3. Fetch variants â†’ ["matrix_2x2", "matrix_2x3"]
4. Random select â†’ "matrix_2x3" (50% probability each)
5. Assign â†’ slide.variant_id = "matrix_2x3"
```

### Data Flow
```
Director STRAWMAN:
â”œâ”€â”€ generated_title (50 chars) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”œâ”€â”€ generated_subtitle (90 chars)  â”€â”€â”€â”€â”€â”¤
â”œâ”€â”€ footer_text (20 chars)         â”€â”€â”€â”€â”€â”¤
â”œâ”€â”€ narrative + key_points         â”€â”€â”€â”€â”€â”¤
â””â”€â”€ variant_id (random selected)   â”€â”€â”€â”€â”€â”¤
                                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
Text Service v1.2 INPUT:
â”œâ”€â”€ variant_id: "matrix_2x3"
â””â”€â”€ slide_spec:
    â”œâ”€â”€ slide_title: generated_title (for context)
    â”œâ”€â”€ slide_purpose: narrative
    â””â”€â”€ key_message: key_points[0]

Text Service v1.2 OUTPUT:
â””â”€â”€ html: "<div>...rich content...</div>"

Layout Builder L25:
â”œâ”€â”€ slide_title: generated_title (Director)
â”œâ”€â”€ subtitle: generated_subtitle (Director)
â”œâ”€â”€ rich_content: html (Text Service)
â””â”€â”€ presentation_name: footer_text (Director)
```

---

## âœ… Implementation Checklist

### **Phase 1: Variant Catalog & Selection System** âœ… COMPLETE
- [x] Create `src/utils/variant_catalog.py` - Fetch and cache v1.2's 34 variants from `/v1.2/variants`
- [x] Create `src/utils/variant_selector.py` - Random variant selection with equal probability
- [x] Create `src/utils/slide_type_mapper.py` - Map Director's 13 types â†’ v1.2's 10 slide types
- [x] Test catalog loading and variant selection randomization

**Files Created**:
1. `src/utils/variant_catalog.py` (329 lines) - Loads catalog from v1.2 API
2. `src/utils/variant_selector.py` (366 lines) - Random selection with equal probability
3. `src/utils/slide_type_mapper.py` (174 lines) - 13â†’10 type mapping

### **Phase 2: Enhanced Slide Model with Character Limits** âœ… COMPLETE
- [x] Update `src/models/agents.py` - Add `variant_id`, `generated_title`, `generated_subtitle` fields to Slide
- [x] Update `src/models/agents.py` - Add `footer_text` field to PresentationStrawman
- [x] Enforce character limits: title=50, subtitle=90, footer=20 using Pydantic `Field(max_length=...)`
- [x] Test Pydantic validation with over-length strings

**Files Modified**:
1. `src/models/agents.py` - Added 3 new fields to Slide model (lines 145-165)
2. `src/models/agents.py` - Added footer_text to PresentationStrawman (lines 231-237)

**New Model Fields**:
```python
class Slide(BaseModel):
    variant_id: Optional[str]  # e.g., "matrix_2x3"
    generated_title: Optional[str] = Field(None, max_length=50)
    generated_subtitle: Optional[str] = Field(None, max_length=90)

class PresentationStrawman(BaseModel):
    footer_text: Optional[str] = Field(None, max_length=20)
```

### **Phase 3: v1.2 Request Transformer** âœ… COMPLETE
- [x] Create `src/utils/v1_2_transformer.py` - Transform Slide â†’ V1_2_GenerationRequest
- [x] Pass `variant_id` from Director's random selection
- [x] Pass `slide_title` from Director's `generated_title` (INPUT for context)
- [x] Build `SlideSpecification` from slide narrative/key_points
- [x] Build `PresentationSpecification` with context from strawman
- [x] Test transformation with sample slides

**Files Created**:
1. `src/utils/v1_2_transformer.py` (316 lines) - Complete request transformation

**Key Functions**:
- `transform_slide_to_v1_2_request()` - Main transformation
- `build_prior_slides_summary()` - Narrative flow context
- `transform_batch()` - Batch transformation support

### **Phase 4: Text Service v1.2 Client** âœ… COMPLETE
- [x] Create `src/utils/text_service_client_v1_2.py` - v1.2 API client
- [x] Change base URL to v1.2: `https://web-production-5daf.up.railway.app`
- [x] Implement `POST /v1.2/generate` endpoint
- [x] Parse v1.2 response: `{success, html, elements, validation, metadata}`
- [x] Handle character count validation warnings (log but don't block)
- [x] Test API calls to v1.2 production endpoint

**Files Created**:
1. `src/utils/text_service_client_v1_2.py` (362 lines) - Full v1.2 client

**Key Methods**:
- `generate()` - Main generation call to `/v1.2/generate`
- `health_check()` - Service health validation
- `get_variants()` - Fetch variant catalog
- `get_variant_details()` - Get variant specifications

### **Phase 5: Service Router v1.2** âœ… COMPLETE
- [x] Create `src/utils/service_router_v1_2.py` - v1.2-specific router
- [x] Use v1_2_transformer in `_build_slide_request()`
- [x] Pass `variant_id` from slide.variant_id
- [x] Implement sequential processing (v1.2 has single endpoint)
- [x] Test routing with multiple slide types

**Files Created**:
1. `src/utils/service_router_v1_2.py` (268 lines) - Sequential routing logic

**Key Changes from v1.1**:
- No ServiceRegistry needed (single endpoint)
- Uses V1_2_Transformer for all requests
- Sequential processing with prior slides context

### **Phase 6: Content Transformer Update** âœ… COMPLETE
- [x] Update `src/utils/content_transformer.py` - Use Director's `generated_title` for L25 `slide_title`
- [x] Update `src/utils/content_transformer.py` - Use Director's `generated_subtitle` for L25 `subtitle`
- [x] Update `src/utils/content_transformer.py` - Use Text Service's `response["html"]` for L25 `rich_content`
- [x] Update `src/utils/content_transformer.py` - Use Director's `footer_text` for L25 `presentation_name`
- [x] Handle hero slides (L29): Text Service HTML â†’ `hero_content`
- [x] Test content transformation with enriched slides

**Files Modified**:
1. `src/utils/content_transformer.py` - Updated `_map_content_slide()` method (lines 249-351)

**Key Logic**:
```python
# v1.2: HTML string (complete HTML for rich_content area)
if isinstance(generated_content, str):
    result = {
        "slide_title": slide.generated_title,  # Director
        "subtitle": slide.generated_subtitle,  # Director
        "rich_content": generated_content,     # v1.2 HTML
        "presentation_name": presentation.footer_text  # Director
    }
```

### **Phase 7: Configuration Updates** â³ IN PROGRESS
- [ ] Update `config/settings.py` - Change TEXT_SERVICE_URL to v1.2 production
- [ ] Update `config/settings.py` - Add TEXT_SERVICE_VERSION = "1.2"
- [ ] Update `config/settings.py` - Add TEXT_SERVICE_VALIDATE_COUNTS = True
- [ ] Update `.env.example` with new v1.2 settings
- [ ] Test configuration loading

**Next Steps**: Update settings.py with v1.2 configuration

### **Phase 8: Director GENERATE_STRAWMAN Enhancement** â³ PENDING
- [ ] Update `src/agents/director.py` - Load variant catalog at initialization
- [ ] Update `src/agents/director.py` - Generate `generated_title` per slide (max 50 chars) using LLM
- [ ] Update `src/agents/director.py` - Generate `generated_subtitle` per slide (max 90 chars) using LLM
- [ ] Update `src/agents/director.py` - Generate `footer_text` for presentation (max 20 chars) using LLM
- [ ] Update `src/agents/director.py` - Assign random `variant_id` using VariantSelector
- [ ] Add truncation logic with "..." if LLM generates over-length content
- [ ] Test strawman generation with new fields populated

**Required Logic**:
```python
# During GENERATE_STRAWMAN stage:
variant_catalog = await VariantCatalog(TEXT_SERVICE_URL).load_catalog()
variant_selector = VariantSelector(variant_catalog)

for slide in strawman.slides:
    # 1. Classify (existing)
    slide.slide_type_classification = SlideTypeClassifier.classify(...)

    # 2. Assign layout (existing)
    slide.layout_id = "L29" if is_hero else "L25"

    # 3. NEW: Select random variant
    slide.variant_id = variant_selector.select_variant(
        slide.slide_type_classification
    )

    # 4. NEW: Generate titles using LLM
    slide.generated_title = await generate_title(slide.title, max_chars=50)
    slide.generated_subtitle = await generate_subtitle(slide.narrative, max_chars=90)

# 5. NEW: Generate footer
strawman.footer_text = await generate_footer(strawman.main_title, max_chars=20)
```

### **Phase 9: Integration Testing** â³ PENDING
- [ ] Create `tests/test_v1_2_integration.py` - Test variant catalog loading
- [ ] Create `tests/test_v1_2_integration.py` - Test variant selection randomization
- [ ] Create `tests/test_v1_2_integration.py` - Test character limit enforcement
- [ ] Create `tests/test_v1_2_integration.py` - Test single slide generation (each of 13 types)
- [ ] Create `tests/test_v1_2_integration.py` - Test full 10-slide presentation end-to-end
- [ ] Create `tests/test_v1_2_integration.py` - Test error handling (invalid variant, API timeout)
- [ ] Test with Layout Builder v7.5 - verify HTML renders correctly
- [ ] Performance test: <30s for 10-slide deck

### **Phase 10: Documentation & Cleanup** â³ PENDING
- [ ] Create `docs/V1_2_INTEGRATION.md` - Integration architecture documentation
- [ ] Create `docs/VARIANT_SELECTION.md` - Variant mapping documentation
- [ ] Update `README.md` - Document v1.2 integration and new character limits
- [ ] Deprecate `src/utils/service_registry.py` (no longer needed for v1.1 endpoints)
- [ ] Add migration guide from v1.1 to v1.2
- [ ] Code review and cleanup

---

## ğŸ“ Files Summary

### **New Files Created (7)**
1. âœ… `src/utils/variant_catalog.py` (329 lines) - Variant catalog loader
2. âœ… `src/utils/variant_selector.py` (366 lines) - Random variant selection
3. âœ… `src/utils/slide_type_mapper.py` (174 lines) - Type mapping
4. âœ… `src/utils/v1_2_transformer.py` (316 lines) - Request transformation
5. âœ… `src/utils/text_service_client_v1_2.py` (362 lines) - v1.2 API client
6. âœ… `src/utils/service_router_v1_2.py` (268 lines) - v1.2 router
7. âœ… `docs/V3.4_V1.2_INTEGRATION_PLAN.md` (this file)

**Total New Code**: ~2,215 lines

### **Modified Files (2)**
1. âœ… `src/models/agents.py` - Added variant_id, generated titles, footer_text
2. âœ… `src/utils/content_transformer.py` - Updated L25 mapping logic

### **Pending Files (5)**
1. â³ `config/settings.py` - Add v1.2 configuration
2. â³ `src/agents/director.py` - Enhanced GENERATE_STRAWMAN
3. â³ `tests/test_v1_2_integration.py` - Integration tests
4. â³ `docs/V1_2_INTEGRATION.md` - Architecture docs
5. â³ `docs/VARIANT_SELECTION.md` - Variant mapping docs

---

## ğŸ” Technical Implementation Details

### Variant Catalog Structure
```python
{
  "total_variants": 34,
  "slide_types": {
    "matrix": [
      {"variant_id": "matrix_2x2", "slide_type": "matrix", ...},
      {"variant_id": "matrix_2x3", "slide_type": "matrix", ...}
    ],
    "grid": [...],  # 9 variants
    "comparison": [...],  # 3 variants
    "sequential": [...],  # 3 variants
    "asymmetric": [...],  # 3 variants
    "hybrid": [...],  # 2 variants
    "metrics": [...],  # 4 variants
    "impact_quote": [...],  # 1 variant
    "table": [...],  # 4 variants
    "single_column": [...]  # 3 variants
  }
}
```

### v1.2 Request Format
```python
{
  "variant_id": "matrix_2x3",
  "slide_spec": {
    "slide_title": "Our Strategic Pillars",  # INPUT from Director
    "slide_purpose": "Present four key pillars",
    "key_message": "Customer focus, innovation, excellence, growth",
    "tone": "professional",
    "audience": "Executive team"
  },
  "presentation_spec": {
    "presentation_title": "Q4 Business Review",
    "presentation_type": "Strategic overview",
    "current_slide_number": 3,
    "total_slides": 10,
    "prior_slides_summary": "Slide 1: Opening\nSlide 2: Overview"
  },
  "enable_parallel": true,
  "validate_character_counts": true
}
```

### v1.2 Response Format
```python
{
  "success": true,
  "html": "<div>...complete HTML for rich_content...</div>",
  "elements": [
    {"element_id": "box_1", "generated_content": {...}, ...},
    {"element_id": "box_2", "generated_content": {...}, ...},
    ...
  ],
  "validation": {
    "valid": true,
    "violations": []  # Character count warnings
  },
  "metadata": {
    "variant_id": "matrix_2x3",
    "template_path": "...",
    "element_count": 6,
    "generation_mode": "parallel"
  }
}
```

---

## ğŸ¯ Success Criteria

- [x] Character limits enforced: titleâ‰¤50, subtitleâ‰¤90, footerâ‰¤20
- [x] Variant selection uses equal probability randomization
- [x] Director generates titles/subtitles/footer during STRAWMAN (pending implementation)
- [x] Text Service receives titles as INPUT (for context)
- [x] Text Service returns ONLY rich_content HTML
- [x] No changes needed to Text Service v1.2 API âœ…
- [ ] Full 10-slide presentation generates end-to-end (pending)
- [ ] HTML from v1.2 renders correctly in Layout Builder v7.5 (pending)
- [ ] Performance: <30 seconds for 10-slide deck (pending)

---

## ğŸš¨ Important Notes

### No Text Service Changes Required âœ…
Text Service v1.2 already works exactly as needed:
- Accepts `slide_title` as INPUT (for context)
- Returns ONLY `html` (rich_content body)
- Perfect alignment with Director's architecture

### Backward Compatibility
All v1.1 code remains intact:
- Old clients still work with v1.1
- New v1.2 clients are separate files
- No breaking changes to existing functionality

### Random Seed for Testing
`VariantSelector` supports optional `random_seed` parameter for reproducible testing:
```python
selector = VariantSelector(catalog, random_seed=42)
# Always selects same "random" variants for testing
```

---

## ğŸ“Š Progress Summary

**Overall Progress**: 70% Complete (7 of 10 phases done)

**Lines of Code**:
- New code written: ~2,215 lines
- Modified code: ~150 lines
- Total impact: ~2,365 lines

**Time Estimate**:
- Completed work: ~6-8 hours
- Remaining work: ~3-4 hours
- Total estimate: ~10-12 hours

**Next Immediate Tasks**:
1. Update `config/settings.py` with v1.2 settings
2. Enhance `director.py` GENERATE_STRAWMAN stage
3. Create integration tests
4. Write documentation

---

## ğŸ”— Related Documentation

- [SERVICE_INTEGRATION_OVERVIEW.md](../../../SERVICE_INTEGRATION_OVERVIEW.md) - System architecture
- [Text Service v1.2 API Documentation](../../../agents/text_table_builder/v1.2/docs/API_DOCUMENTATION.md)
- [Text Service v1.2 Architecture](../../../agents/text_table_builder/v1.2/docs/ARCHITECTURE_V1.2.md)
- [Layout Builder v7.5 Schemas](../../config/deck_builder/layout_schemas.json)

---

**Last Updated**: 2025-11-04
**Document Version**: 1.0
**Status**: Living document - updated as implementation progresses
